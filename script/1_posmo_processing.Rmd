---
title: "data_mb"
author: "Martine Besse"
date: "2023-05-12"
output: html_document
---
# Environment
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readr") 
library("sf")
library("ggplot2")
library("dplyr")
library("lubridate") #for timezones
library("raster")
```

# Posmo data exploration

## Import, clean and add useful attributes
### Clean posmo
```{r}
#import and convert to sf object
#posmo <- read_csv("./data/posmo_2023-06-02T00_00_00+02_00-2023-06-02T23_59_59+02_00.csv") %>% st_as_sf(coords = c("lon_x", "lat_y"), crs=4326, remove = FALSE) |> st_transform(2056)

posmo <- read_csv("./data/posmo_2023-05-31.csv") %>% st_as_sf(coords = c("lon_x", "lat_y"), crs=4326, remove = FALSE) |> st_transform(2056)

#clean and add columns
posmo$source <- "posmo"

posmo <- posmo %>% 
       rename("tmode_posmo" = "transport_mode")

posmo$tmode_manual <- NA

to_remove <- c("place_name", "lon_x", "lat_y", "user_id")
posmo <- posmo[ , !(names(posmo) %in% to_remove)]

#add East and North columns
coords <- posmo |> st_coordinates()
posmo <- posmo |> 
  mutate(E =  coords[,1], N = coords[,2])

#update timezone
posmo <- posmo %>%
  mutate(
    datetime = datetime %>% with_tz(tzone = "Europe/Zurich")
  )

```

### Add new variables
#### Compute new values
```{r}
#compute new values
#timelag
posmo <- mutate(posmo, timelag = as.numeric(difftime(lead(datetime), datetime)))

#steplength
posmo <- posmo %>% mutate(steplength_m = sqrt((E-lead(E))^2 + (N-lead(N))^2))

#speed
posmo <- posmo %>% mutate(speed_ms = steplength_m/timelag)
```


#### Add heights
The height comes from the Digital height model DHM25 provided by swisstopo. The raster has been preprocessed on QGIS to be converted into the epsg 2056 (previously 21781) to save calculation time.  
The resolution is 25m. To have more precise information, we could look at the swiss3DAlti if needed.  
```{r}
#Extract values from rasters:
#https://gisday.wordpress.com/2014/03/24/extract-raster-values-from-points-using-r/comment-page-1/
dhm25 <- raster("./data/dhm25_raster/dhm25_2056.tif")
rasValue <- extract(dhm25, posmo)
posmo$H <- rasValue
```

```{r}
plot(dhm25)
plot(posmo)
```

Simplification: we did not consider height of soil compared to height of person or public transport.  
As it is a relative variable to calculate slope, it does not matter.  

```{r}
# Add slope
posmo <- posmo %>% mutate(slope = (lead(H) - H)/steplength_m * 100)
```



### Reorder columns
```{r}
col_order <- c("source", "datetime", "weekday", "tmode_posmo", "tmode_manual" ,"E", "N", "H", "timelag", "steplength_m", "speed_ms", "slope", "geometry")
posmo <- posmo[, col_order]
posmo
```


## Overview
### Overview map
```{r}
ggplot() +
  geom_path(data = posmo, aes(x = E, y = N), colour = 'red') +
  ggtitle("My trajectories from starting to record data 30.03.2023 to now") +
  coord_equal()
```

```{r}
#plot only points
ggplot(posmo) +
  geom_point(aes(E, N, colour = datetime)) +
  coord_equal() #so equally space North and East
```

### Overview time
```{r}
#extract Hour of the day
posmo_hour <- posmo |> 
  mutate(
    H = as.numeric(format(as.POSIXct(posmo$datetime), format = "%H"))
  )

ggplot(posmo_hour, aes(H)) +
  geom_histogram(binwidth = .6)
```


### Select one single date
Select one single date:  
```{r}
posmo_filter <- posmo |>
    filter(as.Date(datetime) == "2023-05-4")
posmo_filter
```

```{r}
#plot trajectories
ggplot(posmo_filter, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```


## Clean data
(remove steps when no recorded, static etc.)  
remove statics: Exercice 3  
Add segment IDs: exercice 3 - task 4 
(similarity measure ex3)
assigning 

## Visualise per zone
Boundaries:  
Zurich: lower left: 2674900.0, 1244000.0  
        upper right: 2689600.0, 1257300  

Waadt: 	lower left: 2480000, 1127600  
        upper right: 2575200, 1195100  
```{r}
# add regions
zh_ll <- c(2674900, 1244000)
zh_ur <- c(2692100, 1260300)

wt_ll <- c(2480000, 1127600)
wt_ur <- c(2575200, 1195100)


posmo$region <- NA
posmo <- posmo |> 
  mutate(region = case_when(E > zh_ll[1] & E < zh_ur[1] & N > zh_ll[2] & N < zh_ur[2] ~ 'Zurich', E > wt_ll[1] & E < wt_ur[1] & N > wt_ll[2] & N < wt_ur[2] ~ 'Waadt'))

posmo_zh <- posmo %>% filter(region == "Zurich")
posmo_waadt <- posmo %>% filter(region == "Waadt")


ggplot(posmo_waadt, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```


# Labelize data
tendency per labelized data (mean speed, mean distance, etc.)

Labels:  
car, train, bus, tram, cycling, kick-scooter, walk, ski, ski_lift, boat
To be sure to cut out unwanted parts, add a margin to the sample.  

## Boats
```{r}
#BOAT (14.05)
#2023-05-14 13:30:00
#2023-05-14 14:42:00

condition_boat1 <- posmo$datetime > as.POSIXct("2023-05-14 13:55:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-14 14:21:00", tz = "Europe/Zurich")

posmo <- posmo %>%
  mutate(tmode_manual = case_when(condition_boat1 ~ 'boat'))

# Visualisation of all labelized tmode datasets
posmo_boats <- posmo %>% filter(tmode_manual == "boat")

#plot trajectories
ggplot(posmo_boats, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```

## Railways
TO TAKE: -

-02.06
26.05
09.05
-05.05
28.04
-04.04
03.04
-31.03 -> to take (but map matched)
30.03

```{r}
#select train segments
condition_train1 <- posmo$datetime > as.POSIXct("2023-03-30 17:00:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-03-30 17:52:00", tz = "Europe/Zurich")

condition_train2 <- posmo$datetime > as.POSIXct("2023-05-26 18:10:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-26 19:15:00", tz = "Europe/Zurich")

condition_train3 <- posmo$datetime > as.POSIXct("2023-05-09 8:40:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-09 10:55:00", tz = "Europe/Zurich")

condition_train4 <- posmo$datetime > as.POSIXct("2023-04-28 12:20:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-04-28 12:50:00", tz = "Europe/Zurich")

condition_train5 <- posmo$datetime > as.POSIXct("2023-04-03 22:15:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-04-04 00:22:00", tz = "Europe/Zurich")

condition_trains <- (condition_train1) | (condition_train2) | (condition_train3) | (condition_train4) | (condition_train5)

#labelize data
posmo <- posmo %>%
  mutate(tmode_manual = case_when(condition_trains ~ 'train'))

# Visualisation of all labelized rails datasets
posmo_rails <- posmo %>% filter(tmode_manual == "train")

#plot trajectories
ggplot(posmo_rails, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```



## Cycling
02.05
-03.05,
15.05,
-17.05,
-23.05,
-24.05,
-25.05,
-31.05,
-1.06

```{r}
#select bikes segments
condition_bike1 <- posmo$datetime > as.POSIXct("2023-05-02 08:31:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-02 08:36:00", tz = "Europe/Zurich")

condition_bike2 <- posmo$datetime > as.POSIXct("2023-05-02 11:49:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-02 12:04:00", tz = "Europe/Zurich")

condition_bike3 <- posmo$datetime > as.POSIXct("2023-05-02 17:44:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-02 18:04:00", tz = "Europe/Zurich")

condition_bike4 <- posmo$datetime > as.POSIXct("2023-05-15 15:57:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-15 16:32:00", tz = "Europe/Zurich")

#condition_bike5 <- 


condition_bikes <- condition_bike1 | condition_bike2 | condition_bike3 | condition_bike4

#labelize data
posmo <- posmo %>%
  mutate(tmode_manual = case_when(condition_bikes ~ 'bike'))

# Visualisation of all labelized tmode datasets
posmo_bikes <- posmo %>% filter(tmode_manual == "bike") %>% filter(region == "Zurich") #just for visualization, bc only one trajectory in Lausanne

#plot trajectories
ggplot(posmo_bikes, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```


# Walking
29.05
22.05
-21.05
20.05
13.05
16.04

```{r}
#select walking segments
condition_walk1 <- posmo$datetime > as.POSIXct("2023-04-16 15:30:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-04-16 15:37:00", tz = "Europe/Zurich")

#there is some static in this one:
condition_walk2 <- posmo$datetime > as.POSIXct("2023-04-16 15:44:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-04-16 15:56:00", tz = "Europe/Zurich")

condition_walk3 <- posmo$datetime > as.POSIXct("2023-05-13 13:29:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-13 15:01:00", tz = "Europe/Zurich")

condition_walk4 <- posmo$datetime > as.POSIXct("2023-05-13 16:40:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-13 22:01:00", tz = "Europe/Zurich")

condition_walk5 <- posmo$datetime > as.POSIXct("2023-05-13 22:04:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-13 22:29:00", tz = "Europe/Zurich")

#there is some statics
condition_walk6 <- posmo$datetime > as.POSIXct("2023-05-20 11:54:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-20 22:35:00", tz = "Europe/Zurich")

condition_walk7 <- posmo$datetime > as.POSIXct("2023-05-22 11:00:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-22 11:42:00", tz = "Europe/Zurich")

condition_walk8 <- posmo$datetime > as.POSIXct("2023-05-29 16:18:00", tz = "Europe/Zurich") & posmo$datetime < as.POSIXct("2023-05-29 16:46:00", tz = "Europe/Zurich")

condition_walks <- condition_walk1 | condition_walk2 | condition_walk3 | condition_walk4 | condition_walk5 | condition_walk6 | condition_walk7 | condition_walk8

#labelize data
posmo <- posmo %>%
  mutate(tmode_manual = case_when(condition_walks ~ 'walk'))

# Visualisation of all labelized tmode datasets
posmo_walks <- posmo %>% filter(tmode_manual == "walk") #%>% filter(region == "Zurich") #Waadt #just for visualization, 

#plot trajectories
ggplot(posmo_walks, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```



```{r}
# to see segments
posmo_test <- posmo |>
  filter(datetime > as.POSIXct("2023-05-29 16:18:00", tz = "Europe/Zurich") & datetime < as.POSIXct("2023-05-29 16:46:00", tz = "Europe/Zurich"))
posmo_test

#plot trajectories
ggplot(posmo_test, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East
```


```{r}
#final labelizing
posmo <- posmo %>%
  mutate(tmode_manual = case_when(condition_walks ~ 'walk',
                                  condition_boat1 ~ 'boat',
                                  condition_trains ~ 'train',
                                  condition_bikes ~ 'bike'
                                  ))


posmo %>% group_by(tmode_manual) %>% count()
```


# Qualify our labelized dataset 
Deriving speed: Ex2 - task5 (rolling window)  


# Limitations due to map matching
For rails:  
ex. of trip 03.31  
16:20 -> 16:40
THIS ILLUSTRATES ISSUE OF MAP MATCHING:  
I took the leb but it matched to railways...
```{r}
posmo_issue1 <- posmo |>
    filter(datetime > as.POSIXct("2023-03-31 16:10:00", tz = "Europe/Zurich") & datetime < as.POSIXct("2023-03-31 16:50:00", tz = "Europe/Zurich"))  %>% mutate(tmode_manual = "train")
posmo_rails

#plot trajectories
ggplot(posmo_issue1, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East

#write.csv(posmo_rails, "lebissue.csv")
```

```{r}

posmo_issue2 <- posmo |>
    filter(datetime > as.POSIXct("2023-06-02 18:30:00", tz = "Europe/Zurich") & datetime < as.POSIXct("2023-06-02 18:41:00", tz = "Europe/Zurich"))  %>% mutate(tmode_manual = "train")
posmo_issue2

#plot trajectories
ggplot(posmo_issue2, aes(E,N, color = datetime)) +
  geom_point() +
  geom_path() +
  coord_equal() #so equally space North and East

#write.csv(posmo_rails, "lebissue.csv")
```